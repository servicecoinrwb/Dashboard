<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HVAC Operations Dashboard</title>
    <link rel="icon" href="https://imageview.replit.app/objects/uploads/d16ab63e-1d1e-4b8f-863c-67e66e4894fc" type="image/png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
   <script src="https://unpkg.com/@babel/standalone@7.23.6/babel.min.js"></script>

    <style>
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes scale-up {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .animate-fade-in-up {
            animation: fade-in-up 0.3s ease-out forwards;
        }
        .animate-fade-in {
            animation: fade-in 0.2s ease-out forwards;
        }
        .animate-scale-up {
            animation: scale-up 0.2s ease-out forwards;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">

    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="env,react">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, query, orderBy, limit, writeBatch } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        // Removed Analytics import to prevent 403 PERMISSION_DENIED errors

        const { useState, useEffect, useRef } = React;

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyD1VBqOe92fyEe7Z565V-zyRSXz3vtZkEY", 
            authDomain: "dashboard-479319.firebaseapp.com",
            projectId: "dashboard-479319",
            storageBucket: "dashboard-479319.firebasestorage.app",
            messagingSenderId: "828361915368",
            appId: "1:828361915368:web:bc0ba0e7549ed76e78825d"
            // Removed measurementId
        };

        const app = initializeApp(firebaseConfig);
        // Removed analytics initialization
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        
        // --- KEY FIX: MATCH ZAPIER EXACTLY ---
        // We force this to 'default-app-id' because that is exactly where Zapier is writing the data.
        const appId = 'default-app-id';

        // --- Icons (Inline SVGs) ---
        const Icons = {
            Wrench: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>,
            CreditCard: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg>,
            TrendingUp: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
            Calculator: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>,
            Briefcase: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>,
            LayoutGrid: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg>,
            Search: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            ExternalLink: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></svg>,
            Users: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            FileText: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>,
            Thermometer: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z"/></svg>,
            ShieldCheck: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="m9 12 2 2 4-4"/></svg>,
            Megaphone: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m3 11 18-5v12L3 14v-3z"/><path d="M11.6 16.8a3 3 0 1 1-5.8-1.6"/></svg>,
            Workflow: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="8" height="8" x="3" y="3" rx="2"/><path d="M7 11v4a2 2 0 0 0 2 2h4"/><rect width="8" height="8" x="13" y="13" rx="2"/></svg>,
            Globe: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>,
            Plus: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Trash2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Edit2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>,
            X: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Save: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            Lock: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            Unlock: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>,
            LogOut: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>,
            CheckCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            AlertTriangle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>,
            Bell: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>,
            History: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/><path d="M12 7v5l4 2"/></svg>,
            ChevronDown: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="6 9 12 15 18 9"/></svg>,
            ChevronRight: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="9 18 15 12 9 6"/></svg>,
        };

        const IconRenderer = ({ iconName, className }) => {
            const Icon = Icons[iconName] || Icons.ExternalLink;
            return <Icon className={className} />;
        };

        const INITIAL_CATEGORIES = [
          {
            title: 'Service & Operations',
            iconName: 'Wrench',
            order: 1,
            description: 'Field management, dispatch, and technical review tools.',
            links: [
              { name: 'Service Field App', url: 'https://www.appsheet.com/start/90811d78-1165-4542-bbaa-af393ca455a5?platform=desktop#appName=SVC-QApp-721685306&vss=H4sIAAAAAAAAA52OvQ7CMBCD38VzniArYgAEC4iFdEibqxTRJlWTAlWUd-fCj1iB8Xz-bCdcLF33UTdnyFP6XBuaIZEUDvNAClJh4V0cfacgFHa6f4prXweFjFyJNxspQKbvUfl_q4A15KJtLY0lp1DMvxh-F4KF4kcW6Keo644eI9mfM2utb6ZA5sgTfqwOK7e8DdqZrTcc1-ouUL4DXt8N6VEBAAA=&view=Jobs', iconName: 'Briefcase', desc: 'Main AppSheet for field technicians.' },
              { name: 'Service Dept. Hub', url: 'https://hvac-service-department.web.app/', iconName: 'Users', desc: 'Central hub for service department.' },
              { name: 'Tech Review App', url: 'https://nonprod2-svc-3nhd.web.app/', iconName: 'ShieldCheck', desc: 'Quality control and technician reviews.' },
              { name: 'Operations Portal', url: 'https://portal.mechanicaltemp.com/', iconName: 'Globe', desc: 'Main business portal.' }
            ]
          },
          {
            title: 'Sales & Marketing',
            iconName: 'TrendingUp',
            order: 2,
            description: 'Lead generation, workflows, and sales enablement.',
            links: [
              { name: 'Sales Tool', url: 'https://salestool.mechanicaltemp.com/', iconName: 'TrendingUp', desc: 'Quoting and sales presentation tools.' },
              { name: 'Marketing Site', url: 'https://marketing.mechanicaltemp.com/', iconName: 'Megaphone', desc: 'Public facing marketing materials.' },
              { name: 'Marketing Workflow', url: 'https://marketing.mechanicaltemp.com/workflow.html', iconName: 'Workflow', desc: 'Process maps and automation workflows.' }
            ]
          },
          {
            title: 'Finance & Admin',
            iconName: 'CreditCard',
            order: 3,
            description: 'Invoicing, bookkeeping, and financial tracking.',
            links: [
              { name: 'Bookkeeper', url: 'https://bookkeeper.mechanicaltemp.com/', iconName: 'FileText', desc: 'Financial records and bookkeeping.' },
              { name: 'Invoice Generator', url: 'https://servicecoinrwb.github.io/invoice-generator/', iconName: 'CreditCard', desc: 'Create and send invoices quickly.' }
            ]
          },
          {
            title: 'Technical Tools',
            iconName: 'Calculator',
            order: 4,
            description: 'Calculators and tracking for specialized equipment.',
            links: [
              { name: 'Refrigeration Sizer', url: 'https://refrigerationsizer.mechanicaltemp.com/', iconName: 'Thermometer', desc: 'Sizing calculator for refrigeration.' },
              { name: 'ECOTrack', url: 'https://servicecoinrwb.github.io/ECOTrack/', iconName: 'LayoutGrid', desc: 'Environmental compliance tracking.' }
            ]
          }
        ];

        // --- Notification Component ---
        const Notification = ({ notification, onClose, onView, onHistory }) => {
            // Helper to render the notification content
            const renderContent = () => (
                <div className={`flex flex-col gap-3 px-5 py-4 rounded-xl shadow-2xl border ${notification && notification.type === 'success' ? 'bg-white border-green-200' : 'bg-white border-blue-200'}`}>
                    <div className="flex items-start gap-3">
                        <div className={`p-2 rounded-full shrink-0 ${notification && notification.type === 'success' ? 'bg-green-100 text-green-600' : 'bg-blue-100 text-blue-600'}`}>
                            {notification && notification.type === 'success' ? <Icons.CheckCircle className="w-5 h-5" /> : <Icons.Bell className="w-5 h-5" />}
                        </div>
                        <div className="flex-grow">
                            <h4 className={`font-bold text-sm ${notification && notification.type === 'success' ? 'text-green-800' : 'text-blue-800'}`}>
                                {notification ? (notification.type === 'success' ? 'Success' : 'New Notification') : 'Notifications'}
                            </h4>
                            <p className="text-slate-600 text-sm mt-0.5 line-clamp-2">
                                {notification ? notification.message : 'No new alerts'}
                            </p>
                        </div>
                        {notification && (
                            <button 
                                onClick={onClose} 
                                className="text-slate-400 hover:text-slate-600 p-1"
                            >
                                <Icons.X className="w-4 h-4" />
                            </button>
                        )}
                    </div>
                    {/* Action Buttons */}
                    <div className="flex gap-2">
                        {notification && (
                            <button 
                                onClick={onView}
                                className={`flex-1 py-2 px-3 rounded-lg text-sm font-semibold transition-colors ${notification.type === 'success' ? 'bg-green-50 text-green-700 hover:bg-green-100' : 'bg-blue-50 text-blue-700 hover:bg-blue-100'}`}
                            >
                                View Details
                            </button>
                        )}
                        <button 
                            onClick={onHistory}
                            className="flex-shrink-0 py-2 px-3 rounded-lg text-sm font-semibold bg-slate-100 text-slate-600 hover:bg-slate-200 transition-colors flex items-center justify-center gap-1"
                            title="View History"
                        >
                            <Icons.History className="w-4 h-4" />
                            History
                        </button>
                    </div>
                </div>
            );

            // Always render the container, but content changes if no notification
            return (
                <div className="fixed bottom-6 right-6 z-[60] animate-fade-in-up max-w-sm w-full">
                    {renderContent()}
                </div>
            );
        };

        // --- Modal Component ---
        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fade-in">
                <div className="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden animate-scale-up max-h-[90vh] flex flex-col">
                    <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 flex-shrink-0">
                    <h3 className="font-bold text-lg text-slate-800">{title}</h3>
                    <button onClick={onClose} className="text-slate-400 hover:text-slate-600 transition-colors">
                        <Icons.X className="w-5 h-5" />
                    </button>
                    </div>
                    <div className="p-6 overflow-y-auto">
                    {children}
                    </div>
                </div>
                </div>
            );
        };

        // --- Login Screen ---
        const LoginScreen = ({ onLogin }) => {
            const [error, setError] = useState(null);

            const handleGoogleLogin = async () => {
                setError(null);
                try {
                    await signInWithPopup(auth, provider);
                } catch (err) {
                    console.error("Login failed", err);
                    setError(err.message);
                }
            };

            return (
                <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center animate-scale-up">
                        <img 
                            src="https://imageview.replit.app/objects/uploads/d16ab63e-1d1e-4b8f-863c-67e66e4894fc" 
                            alt="Mechanical Temp Logo" 
                            className="h-20 w-auto mx-auto mb-6 object-contain"
                        />
                        <h1 className="text-2xl font-bold text-slate-900 mb-2">Mechanical Temp</h1>
                        <p className="text-slate-500 mb-8">Operations Dashboard Access</p>
                        
                        {error && (
                            <div className="bg-red-50 text-red-600 p-3 rounded-lg mb-4 text-sm text-left border border-red-200">
                                <div className="flex items-center gap-2">
                                    <Icons.AlertTriangle className="w-4 h-4" />
                                    <span>{error}</span>
                                </div>
                            </div>
                        )}

                        <button 
                            onClick={handleGoogleLogin}
                            className="w-full flex items-center justify-center gap-3 bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 font-semibold py-3 px-4 rounded-xl transition-all duration-200 shadow-sm hover:shadow-md"
                        >
                            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" className="w-5 h-5" alt="Google" />
                            Sign in with Google
                        </button>
                        
                        <p className="mt-6 text-xs text-slate-400">
                            Authorized personnel only. All access is logged.
                        </p>
                    </div>
                </div>
            );
        };

        // --- Dashboard Component ---
        const Dashboard = () => {
            const [searchTerm, setSearchTerm] = useState('');
            const [user, setUser] = useState(null);
            const [categories, setCategories] = useState([]);
            const [isEditMode, setIsEditMode] = useState(false);
            const [loading, setLoading] = useState(true);
            const [authChecking, setAuthChecking] = useState(true);
            const [notification, setNotification] = useState(null); 
            const [viewingAlert, setViewingAlert] = useState(false); // New state for alert modal
            const [showHistory, setShowHistory] = useState(false); // State for history modal
            const [alertHistory, setAlertHistory] = useState([]); // Store all alerts
            const [expandedCategories, setExpandedCategories] = useState({}); // Collapsed state

            // Modal States
            const [modalType, setModalType] = useState(null); 
            const [editingItem, setEditingItem] = useState(null); 
            const [parentCategoryId, setParentCategoryId] = useState(null); 
            
            // Form States
            const [formData, setFormData] = useState({});

            // Helper for Notifications
            const showNotification = (type, message, id) => {
                setNotification({ type, message, id });
            };

            const handleAcknowledge = async (alertId) => {
                if (!alertId) return;
                try {
                    // Deletes the alert doc so it doesn't show up again
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'alerts', alertId));
                    // If we are viewing the main alert, close it
                    if (notification && notification.id === alertId) {
                        setViewingAlert(false);
                        setNotification(null);
                    }
                } catch (e) {
                    console.error("Error clearing alert:", e);
                }
            };

            const toggleCategory = (id) => {
                setExpandedCategories(prev => ({
                    ...prev,
                    [id]: !prev[id]
                }));
            };

            // Auth Listener
            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    setAuthChecking(false);
                    if (!currentUser) setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            // ----------------------------------------------------
            // NEW: Listener for External Alerts (Zapier/Formspree)
            // ----------------------------------------------------
            useEffect(() => {
                if (!user) return;

                // Listen to the 'alerts' collection for new messages added by Zapier
                const alertsRef = collection(db, 'artifacts', appId, 'public', 'data', 'alerts');
                // We order by creation time to get the newest
                const q = query(alertsRef, orderBy('createdAt', 'desc'), limit(50)); // Fetch last 50 for history

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const allAlerts = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setAlertHistory(allAlerts);

                    // Check for new unread alert (the most recent one)
                    if (allAlerts.length > 0) {
                        // In a real app we might track 'read' status, but here we just show the top one
                        // if we aren't already showing one.
                        const newest = allAlerts[0];
                        // Simple logic: if notification is null, show the newest one
                        if (!notification) {
                             showNotification(newest.type || 'info', newest.message, newest.id);
                        }
                    } else {
                        setNotification(null);
                    }
                });

                return () => unsubscribe();
            }, [user, notification]); // Re-run if user or notification state changes slightly to check queue

            // Data Fetching & Seeding (Categories)
            useEffect(() => {
                if (!user) return;
                setLoading(true);

                const categoriesRef = collection(db, 'artifacts', appId, 'public', 'data', 'categories');
                const q = query(categoriesRef, orderBy('order'));

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    if (snapshot.empty && !snapshot.metadata.fromCache) {
                        const batch = writeBatch(db);
                        INITIAL_CATEGORIES.forEach((cat) => {
                            const newDocRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'categories'));
                            batch.set(newDocRef, cat);
                        });
                        batch.commit()
                            .then(() => showNotification('success', 'Initial data seeded successfully.'))
                            .catch(e => showNotification('error', 'Failed to seed data: ' + e.message));
                    } else {
                        const cats = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setCategories(cats);
                        setLoading(false);
                    }
                }, (error) => {
                    console.error("Error fetching categories:", error);
                    showNotification('error', "Error fetching categories: " + error.message);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [user]);

            const handleLogout = () => {
                signOut(auth);
            };

            const handleSave = async () => {
                try {
                    if (modalType === 'CATEGORY') {
                        if (editingItem) {
                            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'categories', editingItem.id), formData);
                            showNotification('success', 'Section updated successfully');
                        } else {
                            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'categories'), {
                                ...formData,
                                order: categories.length + 1,
                                links: []
                            });
                            showNotification('success', 'New section created successfully');
                        }
                    } else if (modalType === 'LINK') {
                        const category = categories.find(c => c.id === parentCategoryId);
                        if (!category) return;

                        let updatedLinks = [...(category.links || [])];
                        
                        if (editingItem) {
                            const index = updatedLinks.findIndex(l => l.name === editingItem.name);
                            if (index !== -1) updatedLinks[index] = formData;
                            showNotification('success', 'Card updated successfully');
                        } else {
                            updatedLinks.push(formData);
                            showNotification('success', 'New card added successfully');
                        }

                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'categories', parentCategoryId), {
                            links: updatedLinks
                        });
                    }
                    setModalType(null);
                    setFormData({});
                } catch (error) {
                    console.error("Error saving:", error);
                    showNotification('error', "Error saving: " + error.message);
                }
            };

            const handleDeleteLink = async (categoryId, linkIndex) => {
                if (!window.confirm("Are you sure you want to delete this card?")) return;
                try {
                    const category = categories.find(c => c.id === categoryId);
                    const updatedLinks = category.links.filter((_, idx) => idx !== linkIndex);
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'categories', categoryId), {
                        links: updatedLinks
                    });
                    showNotification('success', 'Card deleted successfully');
                } catch (e) {
                    console.error(e);
                    showNotification('error', 'Error deleting card: ' + e.message);
                }
            };

            const handleDeleteCategory = async (categoryId) => {
                if (!window.confirm("Delete this entire section and all its cards?")) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'categories', categoryId));
                    showNotification('success', 'Section deleted successfully');
                } catch (e) {
                    console.error(e);
                    showNotification('error', 'Error deleting section: ' + e.message);
                }
            };

            const openAddLinkModal = (categoryId) => {
                setModalType('LINK');
                setEditingItem(null);
                setParentCategoryId(categoryId);
                setFormData({ name: '', url: '', desc: '', iconName: 'ExternalLink' });
            };

            const openEditLinkModal = (categoryId, link) => {
                setModalType('LINK');
                setEditingItem(link);
                setParentCategoryId(categoryId);
                setFormData({ ...link });
            };

            const openAddCategoryModal = () => {
                setModalType('CATEGORY');
                setEditingItem(null);
                setFormData({ title: '', description: '', iconName: 'LayoutGrid' });
            };

            const openEditCategoryModal = (category) => {
                setModalType('CATEGORY');
                setEditingItem(category);
                setFormData({ title: category.title, description: category.description, iconName: category.iconName });
            };

            const filteredCategories = categories.map(cat => ({
                ...cat,
                links: (cat.links || []).filter(link => 
                    link.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    link.desc.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    cat.title.toLowerCase().includes(searchTerm.toLowerCase())
                )
            })).filter(cat => cat.links.length > 0 || isEditMode);

            if (authChecking) {
                return <div className="min-h-screen flex items-center justify-center bg-slate-50"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div></div>;
            }

            if (!user) {
                return <LoginScreen />;
            }

            return (
                <div className="min-h-screen bg-slate-50 text-slate-900 font-sans pb-20">
                {/* Notification Toast */}
                <Notification 
                    notification={notification} 
                    onClose={() => setNotification(null)} // Keeps "X" to dismiss without viewing
                    onView={() => setViewingAlert(true)} // Opens details modal
                    onHistory={() => setShowHistory(true)} // Opens history modal
                />

                {/* Alert Details Modal */}
                <Modal
                    isOpen={viewingAlert}
                    onClose={() => setViewingAlert(false)}
                    title="Alert Details"
                >
                    <div className="space-y-4">
                        <div className="bg-slate-50 p-4 rounded-lg border border-slate-200">
                            <p className="whitespace-pre-wrap text-slate-700 font-medium leading-relaxed">
                                {notification?.message}
                            </p>
                        </div>
                        <div className="flex justify-end">
                            <button
                                onClick={() => handleAcknowledge(notification?.id)}
                                className="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold flex items-center justify-center gap-2 shadow-sm transition-colors"
                            >
                                <Icons.CheckCircle className="w-5 h-5" />
                                Acknowledge & Clear
                            </button>
                        </div>
                    </div>
                </Modal>

                {/* Alert History Modal */}
                <Modal
                    isOpen={showHistory}
                    onClose={() => setShowHistory(false)}
                    title="Lead History"
                >
                    <div className="space-y-4">
                        {alertHistory.length === 0 ? (
                            <p className="text-center text-slate-500 py-4">No recent history.</p>
                        ) : (
                            alertHistory.map((alert) => (
                                <div key={alert.id} className="bg-white border border-slate-200 rounded-lg p-3 shadow-sm flex flex-col gap-2">
                                    <div className="flex justify-between items-start">
                                        <div className="flex gap-2 items-center">
                                            {alert.type === 'success' ? <div className="w-2 h-2 rounded-full bg-green-500"></div> : <div className="w-2 h-2 rounded-full bg-blue-500"></div>}
                                            <span className="text-xs text-slate-400">
                                                {/* Formatting timestamp if strictly a string or date object is complex without a library, using simple fallback */}
                                                {alert.createdAt ? new Date(alert.createdAt).toLocaleString() : 'Recent'}
                                            </span>
                                        </div>
                                        <button 
                                            onClick={() => handleAcknowledge(alert.id)}
                                            className="text-slate-300 hover:text-red-500 transition-colors"
                                            title="Delete"
                                        >
                                            <Icons.Trash2 className="w-4 h-4" />
                                        </button>
                                    </div>
                                    <p className="text-sm text-slate-700 whitespace-pre-wrap">{alert.message}</p>
                                </div>
                            ))
                        )}
                    </div>
                </Modal>

                {/* Navbar */}
                <nav className="bg-slate-900 text-white shadow-lg sticky top-0 z-40">
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div className="flex items-center justify-between h-16">
                        <div className="flex items-center gap-3">
                        <img 
                            src="https://imageview.replit.app/objects/uploads/d16ab63e-1d1e-4b8f-863c-67e66e4894fc" 
                            alt="Mechanical Temp Logo" 
                            className="h-10 w-auto object-contain rounded-md bg-white p-1"
                        />
                        <div>
                            <span className="font-bold text-xl tracking-tight hidden sm:inline">Mechanical Temp</span>
                            <span className="text-xs block text-slate-400 font-medium">OPERATIONS DASHBOARD</span>
                        </div>
                        </div>
                        
                        <div className="flex items-center gap-4">
                        <div className="hidden md:flex items-center gap-2 text-sm text-slate-400">
                           <img src={user.photoURL} className="w-6 h-6 rounded-full" />
                           {user.displayName}
                        </div>
                        <button 
                            onClick={() => setIsEditMode(!isEditMode)}
                            className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-bold transition-all ${isEditMode ? 'bg-orange-500 text-white animate-pulse' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
                        >
                            {isEditMode ? <Icons.Unlock className="w-3 h-3" /> : <Icons.Lock className="w-3 h-3" />}
                            {isEditMode ? 'EDITING' : 'EDIT'}
                        </button>
                         <button 
                            onClick={handleLogout}
                            className="p-2 text-slate-400 hover:text-white"
                            title="Sign Out"
                        >
                            <Icons.LogOut className="w-5 h-5" />
                        </button>
                        </div>
                    </div>
                    </div>
                </nav>

                {/* Main Content */}
                <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    
                    {/* Search Header */}
                    <div className="mb-10 text-center animate-fade-in">
                    <h1 className="text-3xl font-extrabold text-slate-900 mb-4">
                        Where do you need to go today?
                    </h1>
                    <div className="max-w-xl mx-auto relative">
                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <Icons.Search className="h-5 w-5 text-slate-400" />
                        </div>
                        <input
                        type="text"
                        className="block w-full pl-10 pr-3 py-4 border border-slate-200 rounded-xl leading-5 bg-white shadow-sm placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"
                        placeholder="Search for tools, invoices, or departments..."
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                        />
                    </div>
                    </div>

                    {/* Loading State */}
                    {loading && (
                    <div className="text-center py-20">
                        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                        <p className="mt-4 text-slate-500">Loading Dashboard Config...</p>
                    </div>
                    )}

                    {/* Categories Grid */}
                    <div className="space-y-10">
                    {filteredCategories.map((category) => {
                        // Logic: Expanded if searching OR if explicitly expanded in state. Default (undefined) is collapsed.
                        const isExpanded = searchTerm ? true : !!expandedCategories[category.id];
                        
                        return (
                        <section key={category.id} className="animate-fade-in relative group/section">
                        <div 
                            className="flex items-center justify-between mb-4 border-b border-slate-200 pb-2 cursor-pointer select-none hover:bg-slate-50 transition-colors rounded-t-lg px-2 pt-2"
                            onClick={() => toggleCategory(category.id)}
                        >
                            <div className="flex items-center gap-3">
                            <div className="text-slate-400 hover:text-slate-600 transition-colors">
                                {isExpanded ? <Icons.ChevronDown className="w-5 h-5" /> : <Icons.ChevronRight className="w-5 h-5" />}
                            </div>
                            <IconRenderer iconName={category.iconName} className="w-6 h-6 text-blue-600" />
                            <div>
                                <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2">
                                {category.title}
                                {isEditMode && (
                                    <button 
                                        onClick={(e) => { e.stopPropagation(); openEditCategoryModal(category); }} 
                                        className="p-1 hover:bg-slate-200 rounded text-slate-400 hover:text-blue-600"
                                    >
                                    <Icons.Edit2 className="w-3 h-3" />
                                    </button>
                                )}
                                </h2>
                                <p className="text-sm text-slate-500 hidden sm:block">{category.description}</p>
                            </div>
                            </div>
                            {isEditMode && (
                            <button 
                                onClick={(e) => { e.stopPropagation(); handleDeleteCategory(category.id); }}
                                className="text-red-400 hover:text-red-600 p-2 hover:bg-red-50 rounded"
                            >
                                <Icons.Trash2 className="w-4 h-4" />
                            </button>
                            )}
                        </div>
                        
                        {isExpanded && (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 animate-fade-in">
                            {category.links && category.links.map((link, index) => (
                            <div key={index} className="relative group h-full">
                                <a 
                                href={isEditMode ? undefined : link.url}
                                target={isEditMode ? undefined : "_blank"}
                                rel="noopener noreferrer"
                                className={`block bg-white rounded-xl shadow-sm border border-slate-200 p-5 flex flex-col h-full transition-all duration-200 ${!isEditMode && 'hover:shadow-lg hover:border-blue-300'}`}
                                onClick={(e) => isEditMode && e.preventDefault()}
                                >
                                <div className="flex items-start justify-between mb-3">
                                    <div className={`p-2 rounded-lg transition-colors ${isEditMode ? 'bg-slate-100' : 'bg-slate-100 group-hover:bg-blue-50 group-hover:text-blue-600'}`}>
                                    <IconRenderer iconName={link.iconName} className="w-5 h-5" />
                                    </div>
                                    {!isEditMode && <Icons.ExternalLink className="w-4 h-4 text-slate-300 group-hover:text-blue-400" />}
                                </div>
                                
                                <h3 className={`font-semibold text-lg text-slate-900 mb-1 ${!isEditMode && 'group-hover:text-blue-600'}`}>
                                    {link.name}
                                </h3>
                                
                                <p className="text-sm text-slate-500 mb-4 flex-grow">
                                    {link.desc}
                                </p>
                                
                                {!isEditMode && (
                                    <div className="mt-auto pt-3 border-t border-slate-100 flex items-center text-xs font-medium text-blue-600 opacity-0 group-hover:opacity-100 transition-opacity">
                                    Launch Application &rarr;
                                    </div>
                                )}
                                </a>

                                {/* Edit Overlay for Cards */}
                                {isEditMode && (
                                <div className="absolute top-2 right-2 flex gap-1">
                                    <button 
                                    onClick={() => openEditLinkModal(category.id, link)}
                                    className="p-1.5 bg-white shadow-md border border-slate-200 rounded-full hover:bg-blue-50 text-blue-600"
                                    >
                                    <Icons.Edit2 className="w-3 h-3" />
                                    </button>
                                    <button 
                                    onClick={() => handleDeleteLink(category.id, index)}
                                    className="p-1.5 bg-white shadow-md border border-slate-200 rounded-full hover:bg-red-50 text-red-600"
                                    >
                                    <Icons.Trash2 className="w-3 h-3" />
                                    </button>
                                </div>
                                )}
                            </div>
                            ))}

                            {/* Add New Link Card */}
                            {isEditMode && (
                            <button
                                onClick={() => openAddLinkModal(category.id)}
                                className="flex flex-col items-center justify-center h-full min-h-[160px] border-2 border-dashed border-slate-300 rounded-xl p-5 hover:border-blue-400 hover:bg-blue-50/50 transition-colors text-slate-400 hover:text-blue-500"
                            >
                                <div className="p-3 bg-slate-100 rounded-full mb-2">
                                <Icons.Plus className="w-6 h-6" />
                                </div>
                                <span className="font-medium text-sm">Add New Card</span>
                            </button>
                            )}
                        </div>
                        )}
                        </section>
                    );
                    })}

                    {isEditMode && (
                        <button 
                        onClick={openAddCategoryModal}
                        className="w-full py-8 border-2 border-dashed border-slate-300 rounded-xl text-slate-400 hover:text-blue-600 hover:border-blue-400 hover:bg-slate-50 transition-all flex flex-col items-center justify-center gap-2"
                        >
                        <Icons.Plus className="w-8 h-8" />
                        <span className="font-bold text-lg">Add New Section</span>
                        </button>
                    )}
                    </div>
                </main>

                {/* Edit Modal */}
                <Modal 
                    isOpen={!!modalType} 
                    onClose={() => setModalType(null)}
                    title={
                    modalType === 'CATEGORY' 
                        ? (editingItem ? 'Edit Section' : 'New Section') 
                        : (editingItem ? 'Edit Card' : 'New Card')
                    }
                >
                    <div className="space-y-4">
                    <div>
                        <label className="block text-sm font-medium text-slate-700 mb-1">
                        {modalType === 'CATEGORY' ? 'Section Title' : 'Card Name'}
                        </label>
                        <input 
                        type="text" 
                        className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                        value={formData.name || formData.title || ''}
                        onChange={e => setFormData({ ...formData, [modalType === 'CATEGORY' ? 'title' : 'name']: e.target.value })}
                        placeholder="e.g. Sales Tools"
                        />
                    </div>

                    {modalType === 'LINK' && (
                        <div>
                        <label className="block text-sm font-medium text-slate-700 mb-1">URL</label>
                        <input 
                            type="url" 
                            className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                            value={formData.url || ''}
                            onChange={e => setFormData({ ...formData, url: e.target.value })}
                            placeholder="https://..."
                        />
                        </div>
                    )}

                    <div>
                        <label className="block text-sm font-medium text-slate-700 mb-1">Description</label>
                        <textarea 
                        className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                        rows="2"
                        value={formData.desc || formData.description || ''}
                        onChange={e => setFormData({ ...formData, [modalType === 'CATEGORY' ? 'description' : 'desc']: e.target.value })}
                        placeholder="Brief description of this item..."
                        />
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-slate-700 mb-2">Select Icon</label>
                        <div className="grid grid-cols-5 gap-2 max-h-40 overflow-y-auto p-2 border border-slate-200 rounded-lg">
                        {Object.keys(Icons).map(iconName => (
                            <button
                            key={iconName}
                            type="button"
                            onClick={() => setFormData({ ...formData, iconName })}
                            className={`p-2 rounded flex items-center justify-center hover:bg-blue-50 ${formData.iconName === iconName ? 'bg-blue-100 text-blue-600 ring-2 ring-blue-500' : 'text-slate-500'}`}
                            title={iconName}
                            >
                            <IconRenderer iconName={iconName} className="w-5 h-5" />
                            </button>
                        ))}
                        </div>
                    </div>

                    <div className="pt-4 flex justify-end gap-3">
                        <button 
                        onClick={() => setModalType(null)}
                        className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg font-medium"
                        >
                        Cancel
                        </button>
                        <button 
                        onClick={handleSave}
                        className="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium flex items-center gap-2"
                        >
                        <Icons.Save className="w-4 h-4" />
                        Save Changes
                        </button>
                    </div>
                    </div>
                </Modal>

                {/* Footer */}
                <footer className="bg-white border-t border-slate-200 mt-12 py-8">
                    <div className="max-w-7xl mx-auto px-4 text-center text-slate-400 text-sm">
                    <p>&copy; {new Date().getFullYear()} Mechanical Temp. All rights reserved.</p>
                    <div className="mt-2 flex items-center justify-center gap-2">
                        <span className="w-2 h-2 rounded-full bg-green-500"></span>
                        System Operational
                    </div>
                    </div>
                </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Dashboard />);
    </script>
</body>
</html>
